generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Achievement {
  id              String            @id
  key             String            @unique
  name            String
  description     String
  iconUrl         String?
  chipReward      Int               @default(0)
  xpReward        Int               @default(0)
  UserAchievement UserAchievement[]
}

model GameSession {
  id              String        @id
  createdAt       DateTime      @default(now())
  completedAt     DateTime?
  gameType        GameType
  roomId          String
  hostUserId      String
  initialDeckSeed String?
  finalState      Json
  totalPot        Int
  winners         Json
  User            User          @relation(fields: [hostUserId], references: [id])
  Hand            Hand[]
  Transaction     Transaction[]

  @@index([gameType, createdAt])
  @@index([hostUserId])
}

model Hand {
  id          String      @id
  createdAt   DateTime    @default(now())
  sessionId   String
  handNumber  Int
  playerCards Json
  dealerCards Json
  result      HandResult
  payouts     Json
  GameSession GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, handNumber])
}

model HappyHour {
  id         String   @id
  startTime  DateTime
  endTime    DateTime
  multiplier Float    @default(1.5)
  active     Boolean  @default(true)

  @@index([active, startTime, endTime])
}

model Transaction {
  id            String          @id
  createdAt     DateTime        @default(now())
  userId        String
  amount        Int
  type          TransactionType
  balanceBefore BigInt
  balanceAfter  BigInt
  gameSessionId String?
  description   String?
  metadata      Json?
  GameSession   GameSession?    @relation(fields: [gameSessionId], references: [id])
  User          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([gameSessionId])
  @@index([type])
  @@index([userId, createdAt])
}

model User {
  id                    String            @id
  createdAt             DateTime          @default(now())
  updatedAt             DateTime
  googleId              String?           @unique
  email                 String?           @unique
  displayName           String
  avatarUrl             String?
  nickname              String?           @db.VarChar(30)
  customAvatar          String?           @db.VarChar(500)
  chipBalance           BigInt            @default(1000)
  totalWagered          BigInt            @default(0)
  totalWon              BigInt            @default(0)
  xpPoints              Int               @default(0)
  xpLevel               Int               @default(1)
  vipStatus             VipTier           @default(BRONZE)
  lastLogin             DateTime?
  currentStreak         Int               @default(0)
  bestStreak            Int               @default(0)
  nextStreakReward      DateTime?
  streakFrozen          Boolean           @default(false)
  lastMysteryDrop       DateTime?
  mysteryDropCount      Int               @default(0)
  totalMysteryChips     BigInt            @default(0)
  totalHandsPlayed      Int               @default(0)
  lastHandPlayed        DateTime?
  averageSessionMinutes Float             @default(0)
  publicWins            Int               @default(0)
  biggestWin            BigInt            @default(0)
  biggestWinGameId      String?
  GameSession           GameSession[]
  Transaction           Transaction[]
  UserAchievement       UserAchievement[]

  @@index([currentStreak])
  @@index([email])
  @@index([googleId])
  @@index([lastLogin])
}

model UserAchievement {
  id            String      @id
  createdAt     DateTime    @default(now())
  userId        String
  achievementId String
  progress      Int         @default(0)
  completed     Boolean     @default(false)
  Achievement   Achievement @relation(fields: [achievementId], references: [id])
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, completed])
}

enum GameType {
  WAR
  BLACKJACK
}

enum HandResult {
  PLAYER_WIN
  DEALER_WIN
  TIE
  BLACKJACK
  PLAYER_BUST
  DEALER_BUST
}

enum TransactionType {
  BET
  WIN
  PUSH
  DAILY_STREAK
  MYSTERY_DROP
  ACHIEVEMENT_REWARD
  LEVEL_UP_BONUS
  ADMIN_CREDIT
  ADMIN_DEBIT
  PROMO_CODE
  REFUND
  CORRECTION
}

enum VipTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}
