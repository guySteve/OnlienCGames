generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Achievement {
  id              String            @id
  key             String            @unique
  name            String
  description     String
  iconUrl         String?
  chipReward      Int               @default(0)
  xpReward        Int               @default(0)
  UserAchievement UserAchievement[]
}

model GameSession {
  id              String        @id
  createdAt       DateTime      @default(now())
  completedAt     DateTime?
  gameType        GameType
  roomId          String
  hostUserId      String
  initialDeckSeed String?
  playerSeed      String?       // Player's seed commitment for Provably Fair 2.0
  serverSeed      String?       // Server's QRNG-derived seed for Provably Fair 2.0
  finalState      Json
  totalPot        Int
  winners         Json
  User            User          @relation(fields: [hostUserId], references: [id])
  Hand            Hand[]
  Transaction     Transaction[]

  @@index([gameType, createdAt])
  @@index([hostUserId])
}

model Hand {
  id          String      @id
  createdAt   DateTime    @default(now())
  sessionId   String
  handNumber  Int
  playerCards Json
  dealerCards Json
  result      HandResult
  payouts     Json
  GameSession GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, handNumber])
}

model HappyHour {
  id         String   @id
  startTime  DateTime
  endTime    DateTime
  multiplier Float    @default(1.5)
  active     Boolean  @default(true)

  @@index([active, startTime, endTime])
}

model Transaction {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  userId        String
  amount        Int
  type          TransactionType
  balanceBefore BigInt
  balanceAfter  BigInt
  gameSessionId String?
  relatedUserId String?
  description   String?
  metadata      Json?
  GameSession   GameSession?    @relation(fields: [gameSessionId], references: [id])
  User          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([gameSessionId])
  @@index([type])
  @@index([userId, createdAt])
  @@index([relatedUserId])
}

model User {
  id                    String            @id
  createdAt             DateTime          @default(now())
  updatedAt             DateTime
  googleId              String?           @unique
  email                 String?           @unique
  displayName           String
  avatarUrl             String?
  nickname              String?           @db.VarChar(30)
  customAvatar          String?           @db.VarChar(500)
  needsAvatarSetup      Boolean           @default(true)
  chipBalance           BigInt            @default(1000)
  totalWagered          BigInt            @default(0)
  totalWon              BigInt            @default(0)
  xpPoints              Int               @default(0)
  xpLevel               Int               @default(1)
  vipStatus             VipTier           @default(BRONZE)
  lastLogin             DateTime?
  currentStreak         Int               @default(0)
  bestStreak            Int               @default(0)
  nextStreakReward      DateTime?
  streakFrozen          Boolean           @default(false)
  lastMysteryDrop       DateTime?
  mysteryDropCount      Int               @default(0)
  totalMysteryChips     BigInt            @default(0)
  totalHandsPlayed      Int               @default(0)
  lastHandPlayed        DateTime?
  averageSessionMinutes Float             @default(0)
  publicWins            Int               @default(0)
  biggestWin            BigInt            @default(0)
  biggestWinGameId      String?
  isAdmin               Boolean           @default(false)
  isBanned              Boolean           @default(false)
  bannedAt              DateTime?
  bannedBy              String?
  banReason             String?
  warnCount             Int               @default(0)
  lastWarningAt         DateTime?
  ipAddress             String?
  userAgent             String?
  GameSession           GameSession[]
  Transaction           Transaction[]
  UserAchievement       UserAchievement[]
  friendsInitiated      Friendship[]      @relation("FriendInitiator")
  friendsReceived       Friendship[]      @relation("FriendReceiver")
  ChatMessage           ChatMessage[]
  moderationLogs        ModerationLog[]   @relation("ModeratedUser")
  moderationActions     ModerationLog[]   @relation("Moderator")

  @@index([currentStreak])
  @@index([email])
  @@index([googleId])
  @@index([lastLogin])
  @@index([isBanned])
  @@index([isAdmin])
}

model ChatMessage {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  userId      String
  roomId      String?
  message     String   @db.Text
  isFiltered  Boolean  @default(false)
  isFlagged   Boolean  @default(false)
  flagReason  String?
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([roomId])
  @@index([createdAt])
  @@index([isFlagged])
}

model ModerationLog {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  moderatorId   String?
  userId        String
  action        ModAction
  reason        String?
  details       Json?
  autoModerated Boolean        @default(false)
  Moderator     User?          @relation("Moderator", fields: [moderatorId], references: [id])
  User          User           @relation("ModeratedUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([moderatorId])
  @@index([createdAt])
  @@index([action])
}

enum ModAction {
  WARN
  MUTE
  KICK
  BAN
  UNBAN
  MESSAGE_DELETED
  AUTO_FILTER
}

model Friendship {
  id          String           @id @default(cuid())
  createdAt   DateTime         @default(now())
  userId      String
  friendId    String
  status      FriendshipStatus @default(PENDING)
  user        User             @relation("FriendInitiator", fields: [userId], references: [id], onDelete: Cascade)
  friend      User             @relation("FriendReceiver", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([userId, status])
  @@index([friendId, status])
}

model TableInvite {
  id         String       @id @default(cuid())
  createdAt  DateTime     @default(now())
  roomId     String
  fromUserId String
  toUserId   String
  status     InviteStatus @default(PENDING)
  expiresAt  DateTime

  @@index([toUserId, status])
  @@index([roomId])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model UserAchievement {
  id            String      @id
  createdAt     DateTime    @default(now())
  userId        String
  achievementId String
  progress      Int         @default(0)
  completed     Boolean     @default(false)
  Achievement   Achievement @relation(fields: [achievementId], references: [id])
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, completed])
}

enum GameType {
  WAR
  BLACKJACK
  BINGO
}

enum HandResult {
  PLAYER_WIN
  DEALER_WIN
  TIE
  BLACKJACK
  PLAYER_BUST
  DEALER_BUST
}

enum TransactionType {
  BET
  WIN
  PUSH
  DAILY_STREAK
  MYSTERY_DROP
  ACHIEVEMENT_REWARD
  LEVEL_UP_BONUS
  ADMIN_CREDIT
  ADMIN_DEBIT
  PROMO_CODE
  REFUND
  CORRECTION
  TRANSFER_SENT
  TRANSFER_RECEIVED
  TIP
}

enum VipTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}
